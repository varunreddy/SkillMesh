# SkillMesh v2 Design

## Goal

Scale SkillMesh from ~15 in-memory experts to thousands via ChromaDB-backed hybrid retrieval, and ship ~60 rich domain experts across cloud, APIs, data/finance, security, frontend, and systems.

## Scope

- ChromaDB as persistent vector backend with BM25 re-ranking
- Lightweight `RetrievalBackend` protocol for future extensibility
- In-memory fallback for small registries (< 100 cards)
- Expanded instruction files: 60-100 lines each with anti-patterns, decision trees, composability hints
- ~45 new expert domains on top of existing 15
- API registry format deferred to v3

## Architecture: Retrieval Backend

```
                    ┌─────────────────────┐
                    │   SkillRetriever     │  (public API unchanged)
                    │   .retrieve(query)   │
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────┐
                    │  RetrievalBackend    │  (Protocol)
                    │  .index(cards)       │
                    │  .query(text, top_k) │
                    └──────┬────────┬─────┘
                           │        │
              ┌────────────▼─┐  ┌───▼────────────┐
              │ InMemoryBack │  │ ChromaBackend   │
              │ (BM25+dense) │  │ (ChromaDB+BM25) │
              │ <100 cards   │  │ 100-10K+ cards  │
              └──────────────┘  └─────────────────┘
```

### RetrievalBackend Protocol

```python
class RetrievalBackend(Protocol):
    def index(self, cards: list[ExpertCard]) -> None: ...
    def query(self, text: str, top_k: int = 3) -> list[RetrievalHit]: ...
```

### InMemoryBackend

Extracted from current `retriever.py`. BM25Okapi + optional sentence-transformers dense. RRF fusion. Unchanged behavior.

### ChromaBackend

- Persists to `~/.skillmesh/chroma/` (configurable via `SKILLMESH_DATA_DIR`)
- Collection name derived from registry name + version
- Stores card metadata as ChromaDB document metadata (domain, tags, risk_level, maturity)
- Uses ChromaDB's built-in embedding function (default: `all-MiniLM-L6-v2`) for dense retrieval
- BM25 re-ranking layer on top of ChromaDB results via RRF
- Metadata filtering: can pre-filter by domain, risk_level, maturity before scoring

### Auto-selection

- `SkillRetriever(cards, backend="auto")` — in-memory if len(cards) < 100, else ChromaDB
- `SkillRetriever(cards, backend="memory")` — force in-memory
- `SkillRetriever(cards, backend="chroma")` — force ChromaDB

## CLI Changes

### New command: `skill-rag index`

```bash
skill-rag index \
  --registry examples/registry/tools.enriched.json \
  --collection my-skills \
  --data-dir ~/.skillmesh/chroma
```

Ingests registry into ChromaDB. Incremental — updates changed cards, adds new ones.

### Updated: `skill-rag retrieve` / `skill-rag emit`

- If a ChromaDB collection exists for the registry, uses it automatically
- `--backend memory|chroma|auto` flag to override
- All existing flags preserved

## Instruction File Structure (v2)

Each file expands from ~18 lines to 60-100 lines:

```markdown
# Expert Title

Brief role description.

## When to use this expert
- Trigger conditions

## Execution behavior
1. Step-by-step workflow (expanded)

## Decision tree
- Conditional guidance based on problem characteristics

## Anti-patterns
- NEVER do X (with explanation of why)

## Common mistakes
- Frequent errors practitioners make

## Output contract
- What must be produced (expanded)

## Composability hints
- Upstream/downstream expert recommendations
```

## New Expert Domains (~45 new)

### Cloud + Infrastructure (7)
- `cloud.aws-s3` — bucket ops, lifecycle, presigned URLs
- `cloud.aws-lambda` — handler patterns, cold start, layers
- `cloud.aws-vpc` — networking, subnets, security groups
- `cloud.terraform` — state management, modules, drift detection
- `cloud.docker` — Dockerfile best practices, multi-stage builds
- `cloud.kubernetes` — deployments, services, RBAC, resource limits
- `infra.github-actions` — workflow authoring, secrets, caching

### APIs + Web (6)
- `web.fastapi` — async endpoints, dependency injection, middleware
- `web.flask` — blueprints, app factory, extensions
- `web.auth-jwt` — JWT flow, refresh tokens, RBAC
- `web.auth-oauth` — OAuth2 flows, PKCE, token management
- `web.sqlalchemy` — session management, migrations, relationships
- `web.rest-design` — resource naming, pagination, error responses

### Data + Finance (7)
- `data.pandas-advanced` — groupby, merge strategies, memory optimization
- `data.sql-queries` — joins, CTEs, window functions, query planning
- `data.time-series` — stationarity, decomposition, forecasting
- `finance.quantitative` — portfolio optimization, risk metrics, backtesting
- `finance.financial-modeling` — DCF, multiples, scenario analysis
- `data.spark` — partitioning, broadcast joins, UDFs
- `data.dbt` — model layering, testing, incremental models

### Security + DevSecOps (6)
- `sec.owasp-web` — XSS, CSRF, SQLi prevention patterns
- `sec.secrets-management` — Vault, env vars, rotation
- `sec.container-security` — image scanning, rootless, distroless
- `sec.dependency-scanning` — SCA, CVE triage, lockfile auditing
- `sec.iam-policies` — least-privilege, policy boundaries, audit logging
- `sec.penetration-testing` — methodology, scope, reporting

### Mobile + Frontend (6)
- `fe.react` — hooks patterns, component architecture, performance
- `fe.nextjs` — app router, SSR/SSG, middleware, data fetching
- `fe.react-native` — navigation, native modules, platform-specific code
- `fe.css-architecture` — Tailwind, CSS modules, responsive, design tokens
- `fe.accessibility` — WCAG, ARIA, keyboard nav, screen reader testing
- `fe.state-management` — Redux vs Zustand vs Context, server state

### Systems + Low-level (6)
- `sys.rust` — ownership, lifetimes, error handling, async
- `sys.go` — goroutines, channels, error patterns, interfaces
- `sys.cpp-modern` — smart pointers, RAII, move semantics, templates
- `sys.concurrency` — locks, lock-free, async patterns, race conditions
- `sys.systems-design` — load balancing, caching, sharding, CAP tradeoffs
- `sys.memory-management` — profiling, leak detection, allocation strategies

### Additional ML/DL (7)
- `ml.feature-engineering` — encoding, interaction features, target encoding
- `ml.hyperparameter-tuning` — Optuna, grid/random/Bayesian strategies
- `dl.transformers-finetuning` — HuggingFace fine-tuning, LoRA, evaluation
- `dl.langchain-agents` — chains, agents, memory, tool use
- `ml.model-export` (existing, enriched)
- `dl.pytorch-training` (existing, enriched)
- `ml.sklearn-modeling` (existing, enriched)

## Project Structure (v2)

```
SkillMesh/
├── src/skill_registry_rag/
│   ├── models.py              # ExpertCard, RetrievalHit (unchanged)
│   ├── registry.py            # load_registry (unchanged)
│   ├── retriever.py           # SkillRetriever → delegates to backend
│   ├── backends/              # NEW
│   │   ├── __init__.py        # RetrievalBackend Protocol export
│   │   ├── memory.py          # InMemoryBackend (extracted from retriever.py)
│   │   └── chroma.py          # ChromaBackend
│   ├── adapters/
│   │   ├── codex.py
│   │   └── claude.py
│   └── cli.py                 # + `index` subcommand
├── examples/registry/
│   ├── experts.yaml           # ~60 experts
│   ├── tools.enriched.json    # ~60 experts with full metadata
│   ├── schema.json            # updated
│   └── instructions/          # ~60 files, 60-100 lines each
├── tests/
│   ├── test_registry.py
│   ├── test_retriever.py      # updated for backend abstraction
│   ├── test_backends.py       # NEW
│   ├── test_adapters.py
│   └── test_cli.py            # updated for `index` command
└── pyproject.toml
```

## Dependencies

```toml
dependencies = [
  "numpy>=1.24",
  "PyYAML>=6.0",
  "rank-bm25>=0.2.2",
  "jsonschema>=4.0",
  "chromadb>=0.5.0",
]

[project.optional-dependencies]
dense = ["sentence-transformers>=2.7.0"]
dev = ["pytest>=8.0", "pytest-cov>=5.0", "ruff>=0.6.0"]
```

## Backward Compatibility

- `skill-rag retrieve` without prior `skill-rag index` falls back to in-memory
- Existing YAML/JSON registries work unchanged
- `SkillRetriever(cards)` API unchanged — backend selection is automatic
- All existing tests continue to pass

## Not in v2 (deferred to v3)

- API endpoint registry format (APICard model)
- OpenAPI-to-SkillMesh auto-generator
- MCP bridge / gateway mode
- Community registry package manager (`skillmesh install`)
- Execution feedback loop (did the LLM follow instructions?)
